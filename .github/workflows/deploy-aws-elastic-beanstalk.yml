name: Deploy to AWS Elastic Beanstalk

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  AWS_REGION: us-east-1
  EB_ENVIRONMENT_BACKEND: mivent-backend-env
  EB_ENVIRONMENT_FRONTEND: mivent-frontend-env
  EB_APPLICATION: mivent-app

jobs:
  # Build and test backend
  build-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'backend/package-lock.json'

      - name: Install dependencies
        run: |
          cd backend
          npm ci

      - name: Run tests
        run: |
          cd backend
          npm test || true

      - name: Build
        run: |
          cd backend
          npm run build || true

  # Build and test frontend
  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run tests
        run: |
          cd frontend
          npm test -- --watchAll=false --coverage || true

      - name: Build
        run: |
          cd frontend
          REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }} npm run build

  # Deploy backend to Elastic Beanstalk
  deploy-backend:
    needs: build-backend
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create deployment package
        run: |
          cd backend
          npm install --production
          zip -r ../backend-deploy.zip . -x "*.git*" "node_modules/.*"

      - name: Upload to S3
        run: |
          aws s3 cp backend-deploy.zip s3://${{ secrets.EB_BUCKET }}/backend-deploy-${{ github.sha }}.zip

      - name: Create new Elastic Beanstalk version
        run: |
          aws elasticbeanstalk create-application-version \
            --application-name ${{ env.EB_APPLICATION }} \
            --version-label backend-${{ github.sha }} \
            --source-bundle S3Bucket=${{ secrets.EB_BUCKET }},S3Key=backend-deploy-${{ github.sha }}.zip \
            --region ${{ env.AWS_REGION }}

      - name: Update Elastic Beanstalk environment
        run: |
          aws elasticbeanstalk update-environment \
            --application-name ${{ env.EB_APPLICATION }} \
            --environment-name ${{ env.EB_ENVIRONMENT_BACKEND }} \
            --version-label backend-${{ github.sha }} \
            --region ${{ env.AWS_REGION }}

      - name: Wait for deployment
        run: |
          aws elasticbeanstalk wait environment-updated \
            --application-name ${{ env.EB_APPLICATION }} \
            --environment-name ${{ env.EB_ENVIRONMENT_BACKEND }} \
            --region ${{ env.AWS_REGION }}

  # Deploy frontend to Elastic Beanstalk or S3+CloudFront
  deploy-frontend:
    needs: build-frontend
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Build
        run: |
          cd frontend
          REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }} npm run build
        env:
          CI: false
          REACT_APP_FIREBASE_API_KEY: ${{ secrets.REACT_APP_FIREBASE_API_KEY }}
          REACT_APP_FIREBASE_AUTH_DOMAIN: ${{ secrets.REACT_APP_FIREBASE_AUTH_DOMAIN }}
          REACT_APP_FIREBASE_PROJECT_ID: ${{ secrets.REACT_APP_FIREBASE_PROJECT_ID }}
          REACT_APP_FIREBASE_STORAGE_BUCKET: ${{ secrets.REACT_APP_FIREBASE_STORAGE_BUCKET }}
          REACT_APP_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.REACT_APP_FIREBASE_MESSAGING_SENDER_ID }}
          REACT_APP_FIREBASE_APP_ID: ${{ secrets.REACT_APP_FIREBASE_APP_ID }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # Option 1: Deploy to S3 + CloudFront
      - name: Deploy to S3
        run: |
          aws s3 sync frontend/build s3://${{ secrets.S3_BUCKET_FRONTEND }} --delete

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

      # Option 2: Deploy to Elastic Beanstalk (uncomment if preferred)
      # - name: Create deployment package
      #   run: |
      #     cd frontend
      #     zip -r ../frontend-deploy.zip build/ .platform/ .elasticbeanstalk/ -x "*.git*"
      #
      # - name: Upload to S3
      #   run: |
      #     aws s3 cp frontend-deploy.zip s3://${{ secrets.EB_BUCKET }}/frontend-deploy-${{ github.sha }}.zip
      #
      # - name: Create new Elastic Beanstalk version
      #   run: |
      #     aws elasticbeanstalk create-application-version \
      #       --application-name ${{ env.EB_APPLICATION }} \
      #       --version-label frontend-${{ github.sha }} \
      #       --source-bundle S3Bucket=${{ secrets.EB_BUCKET }},S3Key=frontend-deploy-${{ github.sha }}.zip
      #
      # - name: Update Elastic Beanstalk environment
      #   run: |
      #     aws elasticbeanstalk update-environment \
      #       --application-name ${{ env.EB_APPLICATION }} \
      #       --environment-name ${{ env.EB_ENVIRONMENT_FRONTEND }} \
      #       --version-label frontend-${{ github.sha }}

  # Notify deployment status
  notify:
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Notify Slack on success
        if: needs.deploy-backend.result == 'success' && needs.deploy-frontend.result == 'success'
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "‚úÖ MIVENT Elastic Beanstalk deployment successful",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*MIVENT Deployment Successful* üéâ\n*Commit:* ${{ github.sha }}\n*Branch:* ${{ github.ref }}\n*Author:* ${{ github.actor }}"
                  }
                }
              ]
            }

      - name: Notify Slack on failure
        if: needs.deploy-backend.result == 'failure' || needs.deploy-frontend.result == 'failure'
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "‚ùå MIVENT Elastic Beanstalk deployment failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*MIVENT Deployment Failed* ‚ö†Ô∏è\n*Commit:* ${{ github.sha }}\n*Branch:* ${{ github.ref }}\n*Author:* ${{ github.actor }}\n*Run:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                }
              ]
            }

